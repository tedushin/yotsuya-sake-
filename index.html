<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>（株）よつや外商部</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* ページ全体の基本スタイル */
    body { font-family: sans-serif; margin: 0; padding: 1rem; background-color: #fdfdfd; }
    header { position: sticky; top: 0; background: white; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; }
    .search-bar { max-width: 600px; margin: 1rem auto; display: flex; justify-content: center; }
    .search-bar input { width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    .card-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1rem; padding-bottom: 80px; }
    
    /* 商品選択カードのスタイル */
    .card { background-color: white; border: 1px solid #ddd; border-radius: 10px; width: 30%; min-width: 280px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 1rem; position: relative; }
    .card h3 { margin: 0.5rem 0; }
    .card p { margin: 0.2rem 0; font-size: 0.9rem; }
    .card .price-info { font-weight: bold; color: #c00; }
    .card input[type="checkbox"] { position: absolute; top: 1rem; right: 1rem; transform: scale(1.5); }
    
    /* PDF出力ボタンのコンテナとボタンのスタイル */
    .floating-button-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 999;
    }
    .floating-button {
      background-color: #2196F3;
      color: white;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .floating-button:hover {
      background-color: #1976D2;
    }

    /* --- ここからPDF生成用のスタイル --- */
    #estimate-capture {
      position: absolute;
      left: -9999px;
      top: -9999px;
      width: 210mm; 
      height: 297mm;
      padding: 15mm;
      background: white;
      box-sizing: border-box;
      font-family: 'Hiragino Sans', 'ヒラギノ角ゴ Pro W3', 'メイリオ', Meiryo, 'ＭＳ Ｐゴシック', sans-serif;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .estimate-header {
      text-align: center;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .estimate-header h2 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
    }
    .estimate-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-size: 14px;
    }
    .estimate-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: repeat(6, 1fr);
      gap: 10px;
      flex-grow: 1;
    }
    .estimate-item-pdf {
      border: 1px solid #ccc;
      padding: 5px;
      display: flex;
      flex-direction: row;
      gap: 8px;
      overflow: hidden;
      position: relative;
    }
    .sanchi-label {
      position: absolute;
      top: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: bold;
      border-radius: 0 0 8px 0;
      z-index: 10;
    }
    .estimate-item-pdf .info {
      font-size: 9px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      justify-content: center;
    }
    .estimate-item-pdf .info h3 {
      font-size: 13px;
      font-weight: bold;
      margin: 0 0 4px 0;
      line-height: 1.2;
    }
    .estimate-item-pdf .info p {
      margin: 1px 0;
    }
    .estimate-item-pdf .price-info { font-weight: bold; margin-top: 4px !important; }
    .estimate-item-pdf .info .comment {
        margin-top: 4px;
        font-size: 8px;
        line-height: 1.3;
        color: #555;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;  
        overflow: hidden;
    }
    .estimate-footer {
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }
    .estimate-summary {
        margin-top: auto;
    }
    .estimate-total {
        text-align: right;
        font-size: 16px;
        font-weight: bold;
        padding-top: 10px;
    }
    .estimate-total p {
        margin: 4px 0;
    }
  </style>
</head>
<body>
  <header>（株）よつや外商部</header>
  <div class="search-bar">
    <input type="text" id="search" placeholder="商品を検索...">
  </div>
  <div class="card-container" id="card-container"></div>
  
  <div class="floating-button-container">
    <button class="floating-button" onclick="checkAll()">全てにチェックする</button>
    <button class="floating-button" onclick="uncheckAll()">全てのチェックを外す</button>
    <button class="floating-button" onclick="generatePDF()">選択商品の見積PDF出力</button>
    <button class="floating-button" onclick="generateFullListPDF()">全てのリストを印刷する</button>
  </div>

  <div id="estimate-capture"></div>

  <script>
    let data = [];

    function checkAll() {
      const checkboxes = document.querySelectorAll('.card-container .card input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = true);
    }

    function uncheckAll() {
      const checkboxes = document.querySelectorAll('.card-container .card input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
    }

    async function loadData() {
      try {
        const res = await fetch('sake_list.json');
        if (!res.ok) throw new Error('JSONファイルの読み込みに失敗しました。');
        data = await res.json();
        const displayData = data.filter(item => 
            item["商品名"] && !item["商品名"].includes("定番商品はございません")
        );
        renderCards(displayData);
      } catch (error) {
        console.error(error);
        document.getElementById("card-container").innerText = "商品の読み込みに失敗しました。ファイルを確認してください。";
      }
    }

    function renderCards(items) {
      const container = document.getElementById("card-container");
      container.innerHTML = "";
      items.forEach(item => {
        const originalIndex = data.findIndex(d => d["商品名"] === item["商品名"] && d["蔵元"] === item["蔵元"]);
        const jan = item["720mL500mLJAN"];
        const imageSrc = jan ? `image/${jan}.jpg` : 'image/placeholder.jpg';
        
        // ▼▼▼ 価格表示のロジックをここに追加 ▼▼▼
        let priceHTML = '';
        const price1800 = Number(item["1800mL価格税抜"]);
        const price720 = Number(item["720mL500mL価格税抜"]);

        if (price1800 > 0) {
            priceHTML += `<p class="price-info">1800ml: ${price1800.toLocaleString()}円＋税</p>`;
        }
        if (price720 > 0) {
            priceHTML += `<p class="price-info">720ml: ${price720.toLocaleString()}円＋税</p>`;
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <input type="checkbox" data-index="${originalIndex}"/>
          <div style="width: 100%; aspect-ratio: 1 / 1; background-color: #eee; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center;">
            <img src="${imageSrc}" alt="商品画像" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" onerror="this.onerror=null;this.src='image/placeholder.jpg';">
          </div>
          <h3>${item["商品名"] || "名称不明"}</h3>
          <p><strong>蔵元:</strong> ${item["蔵元"]}</p>
          <p><strong>産地:</strong> ${item["産地"]}</p>
          <p><strong>グレード:</strong> ${item["グレード"]}</p>
          ${priceHTML}
        `;
        container.appendChild(card);
      });
    }

    document.getElementById("search").addEventListener("input", e => {
      const keyword = e.target.value.toLowerCase();
      const filtered = data.filter(item =>
        (item["商品名"]?.toLowerCase().includes(keyword) ||
        item["蔵元"]?.toLowerCase().includes(keyword)) &&
        item["商品名"] && !item["商品名"].includes("定番商品はございません")
      );
      renderCards(filtered);
    });

    async function createPDF(itemsToPrint, title = "御見積書") {
      if (itemsToPrint.length === 0) {
        alert("印刷する商品がありません。");
        return;
      }
      
      const capture = document.getElementById("estimate-capture");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      
      const itemsPerPage = 12;
      const totalPages = Math.ceil(itemsToPrint.length / itemsPerPage);
      let totalAmount = 0;

      // ▼▼▼ 合計金額の計算を1800ml基準に変更 ▼▼▼
      itemsToPrint.forEach(item => {
        const price = Number(item["1800mL価格税抜"]) || 0;
        totalAmount += price;
      });

      for (let i = 0; i < totalPages; i++) {
        const pageIndex = i + 1;
        const chunk = itemsToPrint.slice(i * itemsPerPage, pageIndex * itemsPerPage);
        
        const today = new Date();
        const dateStr = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`;
        
        let pageHTML = `
          <div class="estimate-header">
            <h2>株式会社よつや ${title}</h2>
          </div>
          <div class="estimate-meta">
            <span>発行日: ${dateStr}</span>
            ${title === "御見積書" ? `<span>対象期間: 発行より1ヶ月間有効</span>` : ''}
          </div>
          <div class="estimate-grid">
        `;

        chunk.forEach(item => {
          const jan = item["720mL500mLJAN"];
          const imageSrc = jan ? `image/${jan}.jpg` : 'image/placeholder.jpg';

          // ▼▼▼ PDF内の価格表示ロジックを追加 ▼▼▼
          let pdfPriceHTML = '';
          const price1800_pdf = Number(item["1800mL価格税抜"]);
          const price720_pdf = Number(item["720mL500mL価格税抜"]);

          if (price1800_pdf > 0) {
              pdfPriceHTML += `<p class="price-info">1800ml: ${price1800_pdf.toLocaleString()}円＋税</p>`;
          }
          if (price720_pdf > 0) {
              pdfPriceHTML += `<p class="price-info">720ml: ${price720_pdf.toLocaleString()}円＋税</p>`;
          }
          
          pageHTML += `
            <div class="estimate-item-pdf">
              <div class="sanchi-label">${item["産地"] || ""}</div>
              <div style="flex-shrink: 0; width: 100px; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 2px 0;">
                <img src="${imageSrc}" alt="商品画像" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.onerror=null;this.src='image/placeholder.jpg';">
              </div>
              <div class="info">
                <h3>${item["商品名"]}</h3>
                <p><strong>蔵元:</strong> ${item["蔵元"] || "不明"}</p>
                <p><strong>グレード:</strong> ${item["グレード"] || "不明"}</p>
                ${pdfPriceHTML}
                <p class="comment">${item["コメント"] || ""}</p>
              </div>
            </div>`;
        });
        
        if (chunk.length < itemsPerPage) {
            pageHTML += '<div style="border:0;"></div>'.repeat(itemsPerPage - chunk.length);
        }

        pageHTML += '</div>';

        let footerHTML = '';
        if (pageIndex === totalPages && title === "御見積書") {
          footerHTML += `
            <div class="estimate-summary">
              <div class="estimate-total">
                <p>小計(税抜): ${totalAmount.toLocaleString()} 円</p>
                <p>消費税(10%): ${Math.floor(totalAmount * 0.1).toLocaleString()} 円</p>
                <p>合計金額(税込): ${Math.floor(totalAmount * 1.1).toLocaleString()} 円</p>
              </div>
            </div>`;
        }

        footerHTML += `
          <div class="estimate-footer">
            <span>株式会社よつや 外商部</span>
            <span>Page ${pageIndex} / ${totalPages}</span>
          </div>`;

        capture.innerHTML = pageHTML + footerHTML;
        
        const canvas = await html2canvas(capture, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        
        if (i > 0) {
          pdf.addPage();
        }
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      }

      const fileNameDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      pdf.save(`${title}_${fileNameDate}.pdf`);
    }

    async function generatePDF() {
      const checkedBoxes = document.querySelectorAll(".card input:checked");
      if (checkedBoxes.length === 0) {
        alert("商品を選択してください。");
        return;
      }
      const selectedItems = Array.from(checkedBoxes).map(cb => data[cb.dataset.index]);
      await createPDF(selectedItems, "御見積書");
    }

    async function generateFullListPDF() {
      const allItems = data.filter(item => 
        item["商品名"] && !item["商品名"].includes("定番商品はございません")
      );
      if (confirm(`全${allItems.length}件の商品リストを印刷します。よろしいですか？`)) {
        await createPDF(allItems, "商品リスト");
      }
    }

    loadData();
  </script>
</body>
</html>