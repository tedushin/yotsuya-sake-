<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品管理 - （株）よつや外商部</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 管理画面特有のスタイル */
        body {
            background-color: #f0f2f5;
            padding-bottom: 2rem;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .data-table-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .status-hidden {
            background-color: #fff0f0;
            color: #d32f2f;
        }

        .status-active {
            color: #2e7d32;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 4px;
        }

        .btn-edit {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .btn-delete {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn-visibility {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        /* モーダルフォーム */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header,
        .modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-footer {
            border-bottom: none;
            border-top: 1px solid #eee;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-full {
            grid-column: span 2;
        }

        /* スイッチ */
        .switch-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* トースト通知 */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 2000;
        }

        #toast.show {
            opacity: 1;
        }

        /* Loading Overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #loading-overlay.active {
            display: flex;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Loading...</div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <h1>商品マスター管理</h1>
            <div>
                <button class="btn btn-secondary" onclick="openSettings()" style="margin-right:1rem;">⚙
                    GitHub設定</button>
                <a href="index.html" class="btn btn-secondary"
                    style="text-decoration:none; margin-right:1rem;">アプリへ戻る</a>
                <button class="btn btn-primary" onclick="openModal()">＋ 新規商品登録</button>
            </div>
        </div>

        <div id="gh-status-bar"
            style="background:#e8f5e9; color:#2e7d32; padding:10px; margin-bottom:20px; border-radius:4px; display:none;">
            GitHub連携中: <span id="gh-status-text"></span>
        </div>

        <div class="data-table-wrapper">
            <table id="sake-table">
                <thead>
                    <tr>
                        <th width="60">状態</th>
                        <th width="80">画像</th>
                        <th>商品名</th>
                        <th>蔵元</th>
                        <th>産地</th>
                        <th>価格(1.8L / 720ml)</th>
                        <th>JAN(720/500)</th>
                        <th width="180">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JSで生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 編集・登録モーダル -->
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; height: auto; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="modal-title">商品編集</h2>
                <button class="btn btn-secondary" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body">
                <form id="sake-form">
                    <input type="hidden" id="edit-index">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>商品名</label>
                            <input type="text" id="input-name" required>
                        </div>
                        <div class="form-group">
                            <label>蔵元</label>
                            <input type="text" id="input-kuramoto">
                        </div>
                        <div class="form-group">
                            <label>産地</label>
                            <input type="text" id="input-sanchi">
                        </div>
                        <div class="form-group">
                            <label>グレード</label>
                            <input type="text" id="input-grade">
                        </div>
                        <div class="form-group">
                            <label>価格(1800mL) 税抜</label>
                            <input type="number" id="input-price1800">
                        </div>
                        <div class="form-group">
                            <label>価格(720/500mL) 税抜</label>
                            <input type="number" id="input-price720">
                        </div>
                        <div class="form-group">
                            <label>JANコード (720/500mL)</label>
                            <input type="text" id="input-jan720" placeholder="画像ファイル名にも使用">
                        </div>
                        <div class="form-group">
                            <label>JANコード (1800mL)</label>
                            <input type="text" id="input-jan1800">
                        </div>
                        <div class="form-group form-full"
                            style="background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee;">
                            <label>商品の画像登録</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                                <button type="button" class="btn btn-secondary"
                                    onclick="searchImage()">画像検索(Google)</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <input type="file" id="input-image-file" accept="image/*">
                                <button type="button" class="btn btn-primary"
                                    onclick="uploadImageFile()">画像をアップロード</button>
                                <span style="font-size: 0.8rem; color: #666;">※保存前にJANコードを入力してください（ファイル名に使用されます）</span>
                            </div>
                        </div>
                        <div class="form-group form-full">
                            <label>コメント</label>
                            <textarea id="input-comment" rows="3"></textarea>
                        </div>
                        <div class="form-group form-full">
                            <label class="switch-label">
                                <input type="checkbox" id="input-hidden">
                                <span>この商品を非表示にする</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveData()">保存する</button>
            </div>
        </div>
    </div>

    <!-- GitHub設定モーダル -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>GitHub連携設定</h2>
                <button class="btn btn-secondary" onclick="closeSettings()">✕</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.9rem; color:#666; margin-bottom:1rem;">
                    GitHub Pagesで運用するため、API経由でデータを保存します。<br>
                    Personal Access Token (Repo scope)が必要です。
                </p>
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Owner (Username)</label>
                    <input type="text" id="gh-owner" placeholder="例: user">
                </div>
                <div class="form-group">
                    <label>Repository Name</label>
                    <input type="text" id="gh-repo" placeholder="例: yotsuya-sake-">
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <input type="text" id="gh-branch" placeholder="main" value="main">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveSettings()">設定を保存</button>
            </div>
        </div>
    </div>

    <div id="toast">保存しました</div>

    <script>
        let sakeData = [];
        let dataSha = null; // GitHub API更新用のSHA

        // GitHub Config
        const CONFIG_KEY = 'yotsuya_sake_gh_config';
        let ghConfig = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');

        // Utils for Loading
        function showLoading(msg = 'Loading...') {
            document.getElementById('loading-text').innerText = msg;
            document.getElementById('loading-overlay').classList.add('active');
        }
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // GitHub API Helper
        async function ghApi(path, options = {}) {
            if (!ghConfig.token || !ghConfig.owner || !ghConfig.repo) {
                throw new Error('GitHub設定が完了していません');
            }
            const baseUrl = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${path}`;
            const url = options.branch ? `${baseUrl}?ref=${options.branch}` : baseUrl;

            const headers = {
                'Authorization': `token ${ghConfig.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
            };

            const res = await fetch(url, {
                method: options.method || 'GET',
                headers: headers,
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message || 'GitHub API Error');
            }
            return res.json();
        }

        // Base64 encode/decode (supports Unicode)
        function toBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function fromBase64(str) {
            return decodeURIComponent(escape(window.atob(str)));
        }

        // --- Main Logic ---

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            updateStatusDisplay();
            if (ghConfig.token) {
                loadAdminData();
            } else {
                openSettings(); // 未設定なら設定画面を開く
            }
        });

        function updateStatusDisplay() {
            const bar = document.getElementById('gh-status-bar');
            const text = document.getElementById('gh-status-text');
            if (ghConfig.owner && ghConfig.repo) {
                bar.style.display = 'block';
                text.innerText = `${ghConfig.owner}/${ghConfig.repo} (${ghConfig.branch || 'main'})`;
            } else {
                bar.style.display = 'none';
            }
        }

        // データ読み込み
        async function loadAdminData() {
            showLoading('データを取得中...');
            try {
                // GitHub APIからsake_list.jsonを取得
                const res = await ghApi('sake_list.json', { branch: ghConfig.branch });
                dataSha = res.sha; // 更新時に必要
                const content = fromBase64(res.content);
                sakeData = JSON.parse(content);
                renderTable();
            } catch (e) {
                console.error(e);
                alert('データの読み込みに失敗しました: ' + e.message);
                // ローカルフォールバック（表示のみ）
                if (sakeData.length === 0) {
                    try {
                        const localRes = await fetch('sake_list.json');
                        sakeData = await localRes.json();
                        renderTable();
                        showToast('※ローカルデータを表示中（編集不可）');
                    } catch (e2) { }
                }
            } finally {
                hideLoading();
            }
        }

        // テーブル描画
        function renderTable() {
            const tbody = document.querySelector('#sake-table tbody');
            tbody.innerHTML = '';

            sakeData.forEach((item, index) => {
                const tr = document.createElement('tr');
                const isHidden = item.isHidden === true;
                if (isHidden) tr.classList.add('status-hidden');

                const jan = item["720mL500mLJAN"];
                // GitHub Pagesなどを想定し、相対パスで画像参照
                const imgSrc = jan ? `image/${jan}.jpg` : 'image/placeholder.jpg';

                tr.innerHTML = `
                  <td><span class="${isHidden ? 'status-hidden' : 'status-active'}" style="padding:2px 6px; border-radius:4px; font-size:0.8rem;">${isHidden ? '非表示' : '公開'}</span></td>
                  <td><img src="${imgSrc}" style="width:40px; height:40px; object-fit:contain;" onerror="this.onerror=null;this.src='image/placeholder.jpg';"></td>
                  <td style="font-weight:bold;">${item["商品名"] || '(名称未設定)'}</td>
                  <td>${item["蔵元"] || ''}</td>
                  <td>${item["産地"] || ''}</td>
                  <td>
                    1.8L: ${item["1800mL価格税抜"] || '-'}<br>
                    720ml: ${item["720mL500mL価格税抜"] || '-'}
                  </td>
                  <td>${jan || ''}</td>
                  <td>
                    <button class="action-btn btn-edit" onclick="editItem(${index})">編集</button>
                    <button class="action-btn btn-visibility" onclick="toggleVisibility(${index})">${isHidden ? '公開' : '非表示'}</button>
                    <button class="action-btn btn-delete" onclick="deleteItem(${index})">削除</button>
                  </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 編集・保存ロジック
        async function saveData() {
            if (!dataSha && !confirm('データのSHAが取得できていません。強制上書きしますか？(競合の可能性があります)')) return;

            showLoading('保存中...');

            const index = parseInt(document.getElementById('edit-index').value);
            const isNew = index === -1;

            const newItem = {
                "商品名": document.getElementById('input-name').value,
                "蔵元": document.getElementById('input-kuramoto').value,
                "産地": document.getElementById('input-sanchi').value,
                "グレード": document.getElementById('input-grade').value,
                "1800mL価格税抜": document.getElementById('input-price1800').value,
                "720mL500mL価格税抜": document.getElementById('input-price720').value,
                "720mL500mLJAN": document.getElementById('input-jan720').value,
                "1800mL　JAN": document.getElementById('input-jan1800').value,
                "コメント": document.getElementById('input-comment').value,
                "isHidden": document.getElementById('input-hidden').checked
            };

            if (isNew) {
                sakeData.unshift(newItem);
            } else {
                sakeData[index] = { ...sakeData[index], ...newItem };
            }

            try {
                // GitHubへPUT
                const content = toBase64(JSON.stringify(sakeData, null, 2));
                const res = await ghApi('sake_list.json', {
                    method: 'PUT',
                    body: {
                        message: `Update sake data from Admin Page (${new Date().toISOString()})`,
                        content: content,
                        sha: dataSha,
                        branch: ghConfig.branch
                    }
                });

                dataSha = res.content.sha; // 新しいSHAを保持
                showToast('GitHubに保存しました');
                closeModal();
                renderTable();

            } catch (e) {
                alert('保存エラー: ' + e.message);
                console.error(e);
            } finally {
                hideLoading();
            }
        }

        async function toggleVisibility(index) {
            sakeData[index].isHidden = !sakeData[index].isHidden;
            // 可視性変更だけでも保存するか、UIだけ変えるか。
            // ここでは即時保存する実装にする（ただし編集SHAの問題に注意）
            // 簡易化のため一旦 saveData相当の処理を行う

            showLoading('状態更新中...');
            try {
                const content = toBase64(JSON.stringify(sakeData, null, 2));
                const res = await ghApi('sake_list.json', {
                    method: 'PUT',
                    body: {
                        message: `Update visibility from Admin Page`,
                        content: content,
                        sha: dataSha,
                        branch: ghConfig.branch
                    }
                });
                dataSha = res.content.sha;
                renderTable();
                showToast('更新しました');
            } catch (e) {
                alert('エラー: ' + e.message);
                // 失敗したら戻す
                sakeData[index].isHidden = !sakeData[index].isHidden;
            } finally {
                hideLoading();
            }
        }

        async function deleteItem(index) {
            if (!confirm('本当に削除してもよろしいですか？')) return;
            sakeData.splice(index, 1);

            showLoading('削除中...');
            try {
                const content = toBase64(JSON.stringify(sakeData, null, 2));
                const res = await ghApi('sake_list.json', {
                    method: 'PUT',
                    body: {
                        message: `Delete item from Admin Page`,
                        content: content,
                        sha: dataSha,
                        branch: ghConfig.branch
                    }
                });
                dataSha = res.content.sha;
                renderTable();
                showToast('削除しました');
            } catch (e) {
                alert('エラー: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        // 画像アップロード
        async function uploadImageFile() {
            const fileInput = document.getElementById('input-image-file');
            const file = fileInput.files[0];
            const jan720 = document.getElementById('input-jan720').value;
            const jan1800 = document.getElementById('input-jan1800').value;
            const jan = jan720 || jan1800; // JAN優先順

            if (!file) {
                alert('ファイルを選択してください');
                return;
            }
            if (!jan) {
                alert('JANコードを入力してください（ファイル名決定に必要です）');
                return;
            }

            // 拡張子取得
            const ext = file.name.split('.').pop();
            const filename = `${jan}.${ext}`; // 本来は小文字化など統一したほうがいいがそのまま
            const path = `image/${filename}`;

            const reader = new FileReader();
            reader.onload = async function (e) {
                const contentBase64 = e.target.result.split(',')[1]; // data:image/jpeg;base64,..... から中身だけ抽出

                showLoading('画像をアップロード中...');
                try {
                    // 既存ファイルのチェック（SHA取得のため）
                    let sha = null;
                    try {
                        const checkRes = await ghApi(path, { branch: ghConfig.branch });
                        sha = checkRes.sha;
                    } catch (e) {
                        // 404なら新規作成なので無視
                    }

                    await ghApi(path, {
                        method: 'PUT',
                        body: {
                            message: `Upload image ${filename}`,
                            content: contentBase64,
                            sha: sha, // 新規ならnull(undefined)でOKか要検証 -> API仕様ではomitでおｋ
                            branch: ghConfig.branch
                        }
                    });

                    showToast('画像をアップロードしました');
                    fileInput.value = ''; // クリア
                } catch (err) {
                    alert('アップロード失敗: ' + err.message);
                    console.error(err);
                } finally {
                    hideLoading();
                }
            };
            reader.readAsDataURL(file);
        }

        // --- Modal/Settings UI ---
        const editModal = document.getElementById('edit-modal');
        const settingsModal = document.getElementById('settings-modal');

        function openModal() {
            document.getElementById('modal-title').innerText = '新規商品登録';
            document.getElementById('edit-index').value = '-1';
            document.getElementById('sake-form').reset();
            editModal.classList.add('active');
        }
        function closeModal() {
            editModal.classList.remove('active');
        }

        window.editItem = function (index) {
            const item = sakeData[index];
            document.getElementById('modal-title').innerText = '商品編集';
            document.getElementById('edit-index').value = index;

            document.getElementById('input-name').value = item["商品名"] || "";
            document.getElementById('input-kuramoto').value = item["蔵元"] || "";
            document.getElementById('input-sanchi').value = item["産地"] || "";
            document.getElementById('input-grade').value = item["グレード"] || "";
            document.getElementById('input-price1800').value = item["1800mL価格税抜"] || "";
            document.getElementById('input-price720').value = item["720mL500mL価格税抜"] || "";
            document.getElementById('input-jan720').value = item["720mL500mLJAN"] || "";
            document.getElementById('input-jan1800').value = item["1800mL　JAN"] || "";
            document.getElementById('input-comment').value = item["コメント"] || "";
            document.getElementById('input-hidden').checked = item.isHidden === true;

            editModal.classList.add('active');
        }

        // Settings
        function openSettings() {
            document.getElementById('gh-token').value = ghConfig.token || '';
            document.getElementById('gh-owner').value = ghConfig.owner || '';
            document.getElementById('gh-repo').value = ghConfig.repo || '';
            document.getElementById('gh-branch').value = ghConfig.branch || 'main';
            settingsModal.classList.add('active');
        }
        function closeSettings() {
            settingsModal.classList.remove('active');
        }
        function saveSettings() {
            const token = document.getElementById('gh-token').value.trim();
            const owner = document.getElementById('gh-owner').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const branch = document.getElementById('gh-branch').value.trim();

            if (!token || !owner || !repo) {
                alert('すべての項目を入力してください');
                return;
            }

            ghConfig = { token, owner, repo, branch };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(ghConfig));

            closeSettings();
            updateStatusDisplay();
            showToast('設定を保存しました');
            loadAdminData(); // データ再読み込み
        }

        // 画像検索（Google画像検索を別タブで開く）- 既存機能維持
        window.searchImage = function () {
            const name = document.getElementById('input-name').value;
            const kuramoto = document.getElementById('input-kuramoto').value;
            if (!name) {
                alert('商品名を入力してください');
                return;
            }
            const query = encodeURIComponent(`${kuramoto} ${name}`);
            const url = `https://www.google.com/search?tbm=isch&q=${query}`;
            window.open(url, '_blank');
        }

    </script>
</body>

</html>